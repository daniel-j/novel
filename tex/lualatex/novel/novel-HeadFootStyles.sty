%%
%% This is file `novel-HeadFootStyles.sty', part of class `novel'.
%% Copyright 2017 Robert Allgeyer.
%%
%% 
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
%%
\ProvidesFile{novel-HeadFootStyles.sty}%
[2017/12/25 v1.46.5m LaTeX file (header and footer layouts and styles)]
%% 



%% File `novel-LayoutSettings.sty' reserved space for header/footer,
%% but did not place anything there. In this file, `fancyhdr' syntax
%% defines the layout. The layout are not activated until
%% \AtEndPreamble, and only if the user did not already define the layout
%% in the Preamble.

%% Note that `style' sometimes means `layout`.


\newif \if@StyledHeader % true if user-customized header using \fancyhead
\newif \if@StyledFooter % true if user-customized footer using \fancyfoot
\newif \if@DeleteCSline % true when using dropfolioinside


%% INITIALIZE FANCYHDR
%% -----------------------------------------------------------------------------
%% Before now now, space was reserved for header/footer.
% Start by loading package `fancyhdr' and blanking everything:
%
\newtoggle{@inheadfoot} % true in header or footer
%
\RequirePackage{fancyhdr}
  \renewcommand\headrulewidth{0pt}
  \renewcommand\footrulewidth{0pt}
  \fancyhead[LO,RE,LE,RO,CE,CO]{}
  \fancyfoot[LO,RE,LE,RO,CE,CO]{}
\LetLtxMacro{\@myfancyhead}{\fancyhead}
\LetLtxMacro{\@myfancyfoot}{\fancyfoot}
\renewcommand\fancyhead[2][]{%
  \global\@StyledHeadertrue%
  \@myfancyhead[#1]{\toggletrue{@inheadfoot}{\normalsize#2}}% not global
}
\LetLtxMacro{\@myfancyfoot}{\fancyfoot}
\renewcommand\fancyfoot[2][]{%
  \global\@StyledFootertrue%
  \FPsub{\@footraise}{\@FootJump}{1}%
  \FPmul{\@footraise}{-\@footraise}{\strip@pt\baselineskip}%
  \@myfancyfoot[#1]{%
    \toggletrue{@inheadfoot}% not global
    \stake\smash{\raisebox{\@footraise pt}{{\normalsize{#2}}}}%
  }%
}
%

% \SetLooseHead looseness factor (fontspec LetterSpace) 0=tight, 50=default
\gdef\SetLooseHead#1{
  \gdef\@@loosehead{#1}
  \FPdiv{\@loosehead}{\@@loosehead}{10} % change in method of using fontspec with microtype
  \FPmin{\@looseheadN}{\@loosehead}{50} % Don't want numbers too loose.
  \FPdiv{\@looseheadword}{\@loosehead}{30} % new in v. 1.40.3.
  \FPadd{\@looseheadword}{\@looseheadword}{1}
}
\SetLooseHead{50}
% Create flags to know if \fancyhead and \fancyfoot have been defined by user,
%   somewhere in the Preamble. If not, then pre-defined layout based on trimsize
%   will be applied \AtEndPreamble.





\LetLtxMacro{\@myTempTPS}{\thispagestyle}
% Re-define \thispagestyle based on layout. When it requests only the page
% number, decide what to do based on this command and whether footer is used:
%
%% See AtBeginShipout routine in novel.cls.
%
\newif \if@ThisPageStyle % true if \thispagestyle declared for current page
\AtBeginShipout{\global\@ThisPageStylefalse} % re-sets
\gdef\thispagestyle#1{%
  \global\@ThisPageStyletrue%
  \@tempTFfalse%
  \ifthenelse{\equal{#1}{fancy}}{%
    \@tempTFtrue%
    \@myTempTPS{fancy}%
  }{}%
  \ifthenelse{\equal{#1}{empty}}{%
    \@tempTFtrue%
    \@myTempTPS{empty}%
  }{}%
  \ifthenelse{\equal{#1}{plain}\OR\equal{#1}{fancyplain}\OR\equal{#1}{footer}}{%
    \@tempTFtrue%
    \if@HasFooter \@myTempTPS{fancyplain}%
    \else \@myTempTPS{empty}%
    \fi%
  }{}%
  \ifthenelse{\equal{#1}{forcenumber}}{%
    \@tempTFtrue%
    \if@HasFooter \@myTempTPS{fancyplain}%
    \else \@myTempTPS{fancynumber}%
    \fi%
  }{}%
  %
  \ifthenelse{\equal{#1}{dropfolioinside}% after \clearpage
    \OR \equal{#1}{dropfolio} \OR \equal{#1}{dropfoliolater}}{% compatibility w/ old code
    \@tempTFtrue%
    \if@HasFooter%
      \@myTempTPS{fancyplain}%
    \else%
      \global\@DeleteCSlinetrue%
      \@myTempTPS{empty}%
      \@dropfolioinside
    \fi%
  }{}%
  % With `dropfoliobeneath` only a footer is used, if present. If no footer,
  %  then the styled page number is centered at one baselineskip beneath the
  %  ordinary bottom of the textblock. Thus, the number intrudes into the
  %  bottom margin. This is OK if the bottom margin is wider than minimum.
  %  Whether the margin is wide enough, is for the user to determine, because
  %  the document class does not know the printer's limitations.
  \ifthenelse{\equal{#1}{dropfoliobeneath}}{% after \clearpage
    \@tempTFtrue%
    \if@HasFooter%
      \@myTempTPS{fancyplain}%
    \else%
      \@myTempTPS{empty}%
      \@dropfoliobeneath
    \fi%
  }{}%
  %%
  \if@tempTF\else%
    \ClassWarning{novel}{^^JPage \pagenumberstyle\space has %
    \string\thispagestyle{} ^^J%
    but its argument is not defined. Default substituted. Better fix that.}%
  \fi%
} %
%
%% End initialize fancyhdr.


%% See AtBeginDocument routine in novel.cls:
%% -----------------------------------------------------------------------------
\gdef\@activateHeadFootStyles{ % called AtBeginDocument by novel.cls
  % Pre-configured header/footer styles, unless user over-rode them:
  % \versoheadtext is initialized to \theauthor
  % \rectoheadtext is initialized to \thetitle
  \@ifundefined{versoheadtext}{
    \NewVersoHeadText{\theauthor} % revised in v. 1.40.3
  }{}
  \@ifundefined{rectoheadtext}{
    \NewRectoHeadText{\thetitle} % revised in v. 1.40.3
  }{}
  %
  % ----------------------------------------------------------------------------
  % IF YOU ARE WRITING YOUR OWN HEADER/FOOTER LAYOUT:
  % Look here for the pre-defined layouts, for use as models.
  % Note that if you write \fancyhead or \fancyfoot in the Preamble,
  % that sets the \@StyledHeader flag, so these codes do not over-ride yours.
  \ifthenelse{\equal{\@HeadFootStyle}{1}}{ % default
    \if@StyledHeader\else
      \fancyhead[LE]{\makebox[2.5em][l]{%
        {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}\@myVersoEmblem%
      }
      \fancyhead[RO]{\@myRectoEmblem\makebox[2.5em][r]{%
        {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}%
      }
      \fancyhead[CE]{{\headfont{\addfontfeature{LetterSpace=\@loosehead}\versoheadtext}}}
      \fancyhead[CO]{{\headfont{\addfontfeature{LetterSpace=\@loosehead}\rectoheadtext}}}
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{2}}{
    \global\@StyledHeaderfalse
    \if@StyledFooter\else
      \fancyfoot[LE]{\makebox[2.5em][l]{%
        {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}\@myVersoEmblem%
      }
      \fancyfoot[RO]{\@myRectoEmblem\makebox[2.5em][r]{%
        {\headfont{\addfontfeature{LetterSpace=\@loosehead}\pagenumberstyle}}}%
      }
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{3}}{
    \if@StyledFooter\else
      \fancyfoot[CO,CE]{%
        {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}%
      }
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{4}}{
    \if@StyledHeader\else
      \fancyhead[LE]{\makebox[2.5em][l]{%
        {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}%
        \@myVersoEmblem\hspace{1em}%
        {\headfont{\addfontfeature{LetterSpace=\@loosehead}\versoheadtext}}%
      }
      \fancyhead[RO]{{\headfont{\addfontfeature{LetterSpace=\@loosehead}\rectoheadtext}}%
        \hspace{1em}\@myRectoEmblem\makebox[2.5em][r]{{%
          \headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}%
      }
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{5}}{
    \if@StyledHeader\else
        \fancyhead[CE]{{\headfont{\addfontfeature{LetterSpace=\@loosehead}\versoheadtext}}}
        \fancyhead[CO]{{\headfont{\addfontfeature{LetterSpace=\@loosehead}\rectoheadtext}}}
    \fi
    \if@StyledFooter\else
      \fancyfoot[CO,CE]{%
        {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}%
      }
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{6}}{
    \if@StyledHeader\else
      \fancyhead[LE]{\makebox[2.5em][l]{%
        {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}\@myVersoEmblem%
      }
      \fancyhead[RO]{\@myRectoEmblem\makebox[2.5em][r]{%
        {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}%
      }
      \fancyhead[RE]{{\headfont{\addfontfeature{LetterSpace=\@loosehead}\versoheadtext}}}
      \fancyhead[LO]{{\headfont{\addfontfeature{LetterSpace=\@loosehead}\rectoheadtext}}}
    \fi
  }{}
  %
  %
  % END PRE-DEFINED LAYOUTS AND STYLES.
  % ----------------------------------------------------------------------------
  %
  % Substitute for \thispagestyle{plain}
  \fancypagestyle{fancyplain}{ % if has footer
    \renewcommand\headrulewidth{0pt}
    \renewcommand\footrulewidth{0pt}
    \fancyhead[LO,RE,LE,RO,CE,CO]{}
    \fancyfoot[LO,RE,LE,RO,CE,CO]{}
    \fancyfoot[CO,CE]{{\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}
  }
  % Not a user command, use plain or fancyplain:
  \fancypagestyle{fancynumber}{ % if has header but not footer
    \renewcommand\headrulewidth{0pt}
    \renewcommand\footrulewidth{0pt}
    \fancyhead[LO,RE,LE,RO,CE,CO]{}
    \fancyhead[LE]{\makebox[2.5em][l]{%
      {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}\@myVersoEmblem%
    }
    \fancyhead[RO]{\@myRectoEmblem\makebox[2.5em][r]{%
      {\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}%
    }
    \fancyfoot[LO,RE,LE,RO,CE,CO]{}
  }
  % Now put `fancyhdr' to work:
  \pagestyle{fancy} % default unless over-ridden by \thispagestyle{}
  %
} % end \@activateHeadFootStyles
%
%% end initialize fancyhdr


%% DROPFOLIO
%% -----------------------------------------------------------------------------
% \@dropfolioinside reduces the textblock height by one lineskip. At the bottom,
%   where the last line would have been, the styled page number is centered.
\newlength\@dfpgnumwidth % adjusts horizontal position of drop folio
\newcommand\@dropfolioinside{%
  \enlargethispage{-\nbs}%
  \setlength\@dfpgnumwidth{\widthof{{\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}}% local
  \ifthenelse{\equal{\@AlignTrim}{corner}}{%
    \gsetlength\@tempLength{\dimexpr\@BottomMargin+\paperheight-\@TrimHeight}% local
  }{%
    \gsetlength\@tempLength{\dimexpr\@BottomMargin+0.5\paperheight-0.5\@TrimHeight}% local
  }%
  \ifodd\c@page%
    \AddToShipoutPicture*{%
      \AtPageLowerLeft{%
        \hspace{\dimexpr\oddsidemargin+72.27pt-0.5\@dfpgnumwidth}%
        \charscale[1,0.5\textwidth,\@tempLength]{%
          {{\headfont\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}%
        }%
      }%
    }%
  \else%
    \AddToShipoutPicture*{%
      \AtPageLowerLeft{%
        \hspace{\dimexpr\evensidemargin+72.27pt-0.5\@dfpgnumwidth}%
        \raisebox{\@tempLength}{%
          {{\headfont\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}%
        }%
      }%
    }%
  \fi%
} % end \@dropfolioinside
%
\let\dropfolionow\relax % compatibility with earlier version.
%

% \@dropfoliobeneath does not change the textblock height. The styled page
%   number is centered where an extra line would be, within the bottom margin.
\newcommand\@dropfoliobeneath{%
  \gsetlength\@dfpgnumwidth{\widthof{{\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}}}%
  \AddToShipoutPicture*{%
    \AtPageLowerLeft{%
      \gsetlength\@tempLength{\Trim@Bottom+\@BottomMargin-\nbs}%
      \ifodd\c@page%
        \hspace{\dimexpr\oddsidemargin+72.27pt+0.5\textwidth-0.5\@dfpgnumwidth}%
      \else%
        \hspace{\dimexpr\evensidemargin+72.27pt+0.5\textwidth-0.5\@dfpgnumwidth}%
      \fi%
      \charscale[1,0pt,\@tempLength]%
        {{\headfont{\addfontfeature{LetterSpace=\@looseheadN}\pagenumberstyle}}%
      }%
    }%
  }%
} % end \@dropfoliobeneath
%%
%


% Content of header text (if present) can be changed at any time within
%   the body, using the following commands. If not used, then
%   Verso is initialized to \theauthor and Recto is initialized to \thetitle
%   AtBeginDocument, with adjustments to interword spacing.
% If you wish, you may write the commands with empty arguments, in which case
%   the header still appears with page number (if present), but no text.
%
\newlength\@hfloose % adjusts tracking of head/foot text
\gdef\NewVersoHeadText#1{
  \FPdiv{\@tempN}{\@loosehead}{500}
  \gsetlength\@hfloose{\@tempN em}
  \gdef\versoheadtext{#1}
}
\let\SetVersoHeadText\NewVersoHeadText\relax % for convenience
\let\RenewVersoHeadText\NewVersoHeadText\relax % for convenience
%
\gdef\NewRectoHeadText#1{
  \FPdiv{\@tempN}{\@loosehead}{500}
  \gsetlength\@hfloose{\@tempN em}
  \gdef\rectoheadtext{#1}
}
\let\SetRectoHeadText\NewRectoHeadText\relax % for convenience
\let\RenewRectoHeadText\NewRectoHeadText\relax % for convenience
%
%%



%
%% End of file `novel-HeadFootStyles.sty'


