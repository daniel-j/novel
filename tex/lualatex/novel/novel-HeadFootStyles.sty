%%
%% This is file `novel-HeadFootStyles.sty', part of class `novel'.
%% Copyright 2017 Robert Allgeyer.
%%
%% 
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
%%
\ProvidesFile{novel-HeadFootStyles.sty}%
[2018/01/02 v1.46.5q LaTeX file (header and footer layouts and styles)]
%% 



%% File `novel-LayoutSettings.sty' reserved space for header/footer,
%% but did not place anything there. In this file, `fancyhdr' syntax
%% defines the layout. The layout are not activated until
%% \AtEndPreamble, and only if the user did not already define the layout
%% in the Preamble.

\gdef\@HeadFootStyle{1} % default: header but not footer
\gdef\@myVersoEmblem{} % no default emblem
\gdef\@myRectoEmblem{} % no default emblem


%% SET HEADER/FOOTER STYLE AND RESERVE SPACE FOR HEADER/FOOTER
%% ----------------------------------------------------------------------------
% There are several pre-configured header/footer styles, addressing every
%   situation likely to be seen in popular fiction. The style details are
%   coded, using `fancyhdr' syntax, in novel-HeadFootStyles.sty.
% Each pre-configured style will set these booleans true or false:
\newif \if@HasHeader % true if global page style has header
\newif \if@HasFooter % true if global page style has footer
% If you wish to create a custom head/foot style, you must first choose
%   one of the pre-configured styles, then customize it. That way,
%   the layout engine knows whether header or footer are present.
\gdef\SetHeadFootStyle#1{%
  \if@coverart
    \gdef\@HeadFootStyle{0} % required
    \ifthenelse{\equal{#1}{0}}{}{%
      \ClassWarning{novel}{^^JClass option `coverart' does not %
        allow header/footer. Ignored. ^^J}
    }%
  \else
    \gdef\@HeadFootStyle{1} % default
    \@tempTFfalse
    \ifthenelse{\equal{#1}{0}}{%
      \global\@HasHeaderfalse\global\@HasFooterfalse\@tempTFtrue%
    }{}
    \ifthenelse{\equal{#1}{1}}{%
      \global\@HasHeadertrue\global\@HasFooterfalse\@tempTFtrue%
    }{}
    \ifthenelse{\equal{#1}{2}}{%
      \global\@HasHeaderfalse\global\@HasFootertrue\@tempTFtrue%
    }{}
    \ifthenelse{\equal{#1}{3}}{%
      \global\@HasHeaderfalse\global\@HasFootertrue\@tempTFtrue%
    }{}
    \ifthenelse{\equal{#1}{4}}{%
      \global\@HasHeadertrue\global\@HasFooterfalse\@tempTFtrue%
    }{}
    \ifthenelse{\equal{#1}{5}}{%
      \global\@HasHeadertrue\global\@HasFootertrue\@tempTFtrue%
    }{}
    \ifthenelse{\equal{#1}{6}}{%
      \global\@HasHeadertrue\global\@HasFootertrue\@tempTFtrue%
    }{}
    % Ensure that user choice was on the allowed list:
    \if@tempTF\else
      \ClassError{novel}{Invalid choice for \string\SetHeadFootStyle}%
        {\string\SetHeadFootStyle\space needs choice of 0,1,2,3,4,5,6, ^^J%
        even if you wish to customize using fancyhdr syntax.}%
    \fi
    \gdef\@HeadFootStyle{#1}
  \fi
}%
\let\SetHeadStyle\SetHeadFootStyle\relax % deprecated
%
% \HeadJump is a number from 1 to 3 (may be decimal). It measures the
%   distance from baseline of header text, to first baseline of main text,
%   then divides by the normal baseline.
% So, a \HeadJump of 1 means that the header text is positioned exactly
%   one line above main text (unlikely). A value of 2 skips a whole line.
% The default value is 1.5, which is often used in popular fiction.
% No matter what value is set, it will be re-set to 0 later, if the
%   choice of head/foot style does not have a header.
% Likewise for \FootJump, measuring from baseline of lowermost main text,
%   to baseline of footer text.
\gdef\SetHeadJump#1{%
  \IfDecimal{#1}{%
    \FPiflt{#1}{1}
      \ClassError{novel}{\string\SetHeadJump\space must be at least 1}%
      {\string\SetHeadJump\string from 1 to 3, may be decimal.}%
    \fi
    \FPifgt{#1}{3}
      \ClassError{novel}{\string\SetHeadJump\space must not exceed 3}%
      {\string\SetHeadJump\string from 1 to 3, may be decimal.}%
    \fi
    \gdef\@HeadJump{#1}
  }{%
    \ClassError{novel}{Unable to parse \string\SetHeadJump\space argument}%
    {Needs integer or decimal, but not ending in decimal point or comma. ^^J%
     Must be a number from 1 to 3, but may not be a macro.}%
  }%
}
\SetHeadJump{1.5} % default
%
\gdef\SetFootJump#1{%
  \IfDecimal{#1}{%
    \FPiflt{#1}{1}
      \ClassError{novel}{\string\SetFootJump\space must be at least 1}%
      {\string\SetFootJump\string from 1 to 3, may be decimal.}%
    \fi
    \FPifgt{#1}{3}
      \ClassError{novel}{\string\SetFootJump\space must not exceed 3}%
      {\string\SetFootJump\string from 1 to 3, may be decimal.}%
    \fi
    \gdef\@FootJump{#1}
  }{%
    \ClassError{novel}{Unable to parse \string\SetFootJump\space argument}%
    {Needs integer or decimal, but not ending in decimal point or comma. ^^J%
     Must be a number from 1 to 3, but may not be a macro.}%
  }%
}
\SetFootJump{1.5} % default
%
%% end set style and reserve space for header/footer.


%% Note that `style' sometimes means `layout`.

% Create flags to know if \fancyhead and \fancyfoot have been defined by user,
%   somewhere in the Preamble. If not, then pre-defined layout based on
%   trimsize will be applied \AtEndPreamble.
\newif \if@StyledHeader % true if user-customized header using \fancyhead
\newif \if@StyledFooter % true if user-customized footer using \fancyfoot
\newif \if@DeleteCSline % true when using dropfolioinside
\let\dropfolionow\relax % compatibility with earlier version.
%


%% Used in novel-headfootstyles.sty:
% \SetLooseHead looseness factor (fontspec LetterSpace) 0=tight, 50=default
\gdef\SetLooseHead#1{
  \FPdiv{\@loosehead}{#1}{10} % change method fontspec w/ microtype
  \FPmin{\@looseheadN}{\@loosehead}{50} % don't want numbers too loose
  \FPdiv{\@looseheadword}{\@loosehead}{30} % inter-word, new in v. 1.40.3
  \FPadd{\@looseheadword}{\@looseheadword}{1}
}
\SetLooseHead{50}
%%

%
% See docs for what these emblems do, if used:
\newcommand\SetEmblems[2]{ % verso, recto
  \gdef\@myVersoEmblem{{\headfont #1}}
  \gdef\@myRectoEmblem{{\headfont #2}}
}
\let\SetEmblem\SetEmblems% for convenience
% If you want something fancier than \thepage:
\gdef\SetPageNumberStyle#1{% no small caps, so lowercase roman preserved
  \gdef\pagenumberstyle{{\addfontfeature{Letters=ResetAll}#1}}
}
\SetPageNumberStyle{\thepage}% no small caps
% See novel.cls for the accompanying AtBeginDocument routine.





%% INITIALIZE FANCYHDR
%% ----------------------------------------------------------------------------
%% Before now now, space was reserved for header/footer.
% Start by loading package `fancyhdr' and blanking everything:
%
\newtoggle{@inheadfoot} % true in header or footer
%
\RequirePackage{fancyhdr}
  \renewcommand\headrulewidth{0pt}
  \renewcommand\footrulewidth{0pt}
  \fancyhead[LO,RE,LE,RO,CE,CO]{}
  \fancyfoot[LO,RE,LE,RO,CE,CO]{}
\LetLtxMacro{\@myfancyhead}{\fancyhead}
\LetLtxMacro{\@myfancyfoot}{\fancyfoot}
\renewcommand\fancyhead[2][]{%
  \global\@StyledHeadertrue%
  \@myfancyhead[#1]{\toggletrue{@inheadfoot}{\normalsize #2}}% not global
}
\LetLtxMacro{\@myfancyfoot}{\fancyfoot}
\renewcommand\fancyfoot[2][]{%
  \global\@StyledFootertrue%
  \FPsub{\@footraise}{\@FootJump}{1}%
  \FPmul{\@footraise}{-\@footraise}{\strip@pt\nbs}%
  \@myfancyfoot[#1]{%
    \toggletrue{@inheadfoot}% not global
    \stake\smash{\raisebox{\@footraise pt}{\normalsize #2}}%
  }%
}
%

\LetLtxMacro{\@myTempTPS}{\thispagestyle}
% Re-define \thispagestyle based on layout. When it requests only the page
% number, decide what to do based on this command and whether footer is used:
%
%% See AtBeginShipout routine in novel.cls.
%
\newif \if@ThisPageStyle % true if \thispagestyle declared for current page
\AtBeginShipout{\global\@ThisPageStylefalse} % re-sets
\gdef\thispagestyle#1{%
  \global\@ThisPageStyletrue%
  \@tempTFfalse%
  \ifthenelse{\equal{#1}{fancy}}{%
    \@tempTFtrue%
    \@myTempTPS{fancy}%
  }{}%
  \ifthenelse{\equal{#1}{empty}}{%
    \@tempTFtrue%
    \@myTempTPS{empty}%
  }{}%
  \ifthenelse{\equal{#1}{plain}%
  \OR \equal{#1}{fancyplain} \OR \equal{#1}{footer}}{%
    \@tempTFtrue%
    \if@HasFooter\@myTempTPS{fancyplain}%
    \else\@myTempTPS{empty}%
    \fi%
  }{}%
  \ifthenelse{\equal{#1}{forcenumber}}{%
    \@tempTFtrue%
    \if@HasFooter\@myTempTPS{fancyplain}%
    \else\@myTempTPS{fancynumber}%
    \fi%
  }{}%
  \ifthenelse{\equal{#1}{dropfoliobeneath}}{% after \clearpage
    \@tempTFtrue\if@HasFooter\@myTempTPS{footer}%
    \else\@myTempTPS{dropfoliobeneath}%
    \fi%
  }{}%
  \ifthenelse{\equal{#1}{dropfolioinside}% after \clearpage
  \OR \equal{#1}{dropfolio} \OR \equal{#1}{dropfoliolater}}{% compatibility
    \@tempTFtrue\if@HasFooter\@myTempTPS{footer}%
    \else
      \enlargethispage{-\nbs}
      \@myTempTPS{dropfolioinside}%
    \fi%
  }{}%
  \ifthenelse{\equal{#1}{XXXdropfolioinside}% after \clearpage
  \OR \equal{#1}{dropfolio} \OR \equal{#1}{dropfoliolater}}{% compatibility
    \@tempTFtrue%
    \if@HasFooter\@myTempTPS{fancyplain}%
    \else%
      \global\@DeleteCSlinetrue%
      \@myTempTPS{empty}%
      \@dropfolioinside
    \fi%
  }{}%
  \if@tempTF\else%
    \ClassError{novel}{^^JPage \thepage\space has \string\thispagestyle ^^J%
     but its argument is not on the list of choices. See docs. ^^J}%
  \fi%
} %
%
%% End initialize fancyhdr.

%%
\gdef\@lshftext{\headfont\addfontfeature{LetterSpace=\@loosehead}}
\gdef\@lspagenum{\headfont\addfontfeature{LetterSpace=\@looseheadN}}
%%

% Content of header text (if present) can be changed at any time within
%   the body, using the following commands. If not used, then
%   Verso is initialized to \theauthor and Recto is initialized to \thetitle
%   AtBeginDocument, with adjustments to interword spacing.
% If you wish, you may write the commands with empty arguments, in which case
%   the header still appears with page number (if present), but no text.
%
\gdef\NewVersoHeadText#1{\gdef\versoheadtext{#1}}
\let\SetVersoHeadText\NewVersoHeadText\relax % for convenience
\let\RenewVersoHeadText\NewVersoHeadText\relax % for convenience
%
\gdef\NewRectoHeadText#1{\gdef\rectoheadtext{#1}}
\LetLtxMacro\SetRectoHeadText\NewRectoHeadText\relax % for convenience
\LetLtxMacro\RenewRectoHeadText\NewRectoHeadText\relax % for convenience
%
%%


%% See AtBeginDocument routine in novel.cls:
%% ----------------------------------------------------------------------------
\gdef\@ActivateHeadFootStyles{ % called AtBeginDocument by novel.cls
  % Pre-configured header/footer styles, unless user over-rode them:
  % \versoheadtext is initialized to \theauthor
  % \rectoheadtext is initialized to \thetitle
  \@ifundefined{versoheadtext}{
    \NewVersoHeadText{\theauthor} % revised in v. 1.40.3
  }{}
  \@ifundefined{rectoheadtext}{
    \NewRectoHeadText{\thetitle} % revised in v. 1.40.3
  }{}
  %
  % ---------------------------------------------------------------------------
  % IF YOU ARE WRITING YOUR OWN HEADER/FOOTER LAYOUT:
  % Look here for the pre-defined layouts, for use as models.
  % Note that if you write \fancyhead or \fancyfoot in the Preamble,
  %   that sets the \@StyledHeader flag, so these codes do not over-ride yours.
  % \@lshftext loosens text tracking.
  % \@lspagenum loosens page number tracking, like \@lshftext but capped
  %   at a maximum looseness.
  \ifthenelse{\equal{\@HeadFootStyle}{1}}{ % default
    \if@StyledHeader\else
      \fancyhead[LE]{%
        \makebox[2.5em][l]{\@lspagenum\pagenumberstyle}%
        \@myVersoEmblem%
      }
      \fancyhead[RO]{%
        \@myRectoEmblem%
        \makebox[2.5em][r]{\@lspagenum\pagenumberstyle}%
      }
      \fancyhead[CE]{\@lshftext\versoheadtext}
      \fancyhead[CO]{\@lshftext\rectoheadtext}
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{2}}{
    \global\@StyledHeaderfalse
    \if@StyledFooter\else
      \fancyfoot[LE]{%
        \makebox[2.5em][l]{\@lspagenum\pagenumberstyle}%
        \@myVersoEmblem%
      }
      \fancyfoot[RO]{%
        \@myRectoEmblem%
        \makebox[2.5em][r]{\@lspagenum\pagenumberstyle}%
      }
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{3}}{
    \if@StyledFooter\else
      \fancyfoot[CO,CE]{\@lspagenum\pagenumberstyle}
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{4}}{
    \if@StyledHeader\else
      \fancyhead[LE]{%
        \makebox[2.5em][l]{\@lspagenum\pagenumberstyle}%
        \@myVersoEmblem%
        \hspace{1em}%
        {\@lshftext\versoheadtext}%
      }
      \fancyhead[RO]{%
        {\@lshftext\rectoheadtext}%
        \hspace{1em}%
        \@myRectoEmblem%
        \makebox[2.5em][r]{\@lspagenum\pagenumberstyle}%
      }
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{5}}{
    \if@StyledHeader\else
        \fancyhead[CE]{\@lshftext\versoheadtext}
        \fancyhead[CO]{\@lshftext\rectoheadtext}
    \fi
    \if@StyledFooter\else
      \fancyfoot[CO,CE]{%
        {\@lspagenum\pagenumberstyle}%
      }
    \fi
  }{}
  %
  \ifthenelse{\equal{\@HeadFootStyle}{6}}{
    \if@StyledHeader\else
      \fancyhead[LE]{%
        \makebox[2.5em][l]{\@lspagenum\pagenumberstyle}%
        \@myVersoEmblem%
      }
      \fancyhead[RO]{%
        \@myRectoEmblem%
        \makebox[2.5em][r]{\@lspagenum\pagenumberstyle}%
      }
      \fancyhead[RE]{\@lshftext\versoheadtext}
      \fancyhead[LO]{\@lshftext\rectoheadtext}
    \fi
  }{}
  % END MODELS FOR WRITING YOUR OWN.
  %
  % END PRE-DEFINED LAYOUTS AND STYLES.
  % ---------------------------------------------------------------------------
  %
  % Substitute for \thispagestyle{plain}:
  \fancypagestyle{fancyplain}{ % if has footer
    \renewcommand\headrulewidth{0pt}
    \renewcommand\footrulewidth{0pt}
    \fancyhead[LO,RE,LE,RO,CE,CO]{}
    \fancyfoot[LO,RE,LE,RO,CE,CO]{}
    \fancyfoot[CO,CE]{\@lspagenum\pagenumberstyle}
  }
  %
  \fancypagestyle{dropfolioinside}{
    \renewcommand\headrulewidth{0pt}
    \renewcommand\footrulewidth{0pt}
    \fancyhead[LO,RE,LE,RO,CE,CO]{}
    \fancyfoot[LO,RE,LE,RO]{}
    \fancyfoot[CO,CE]{%
      \raisebox{\dimexpr\@FootJump\nbs}{\@lspagenum\pagenumberstyle}
    }
  }
  %
  \fancypagestyle{dropfoliobeneath}{
    \renewcommand\headrulewidth{0pt}
    \renewcommand\footrulewidth{0pt}
    \fancyhead[LO,RE,LE,RO,CE,CO]{}
    \fancyfoot[LO,RE,LE,RO]{}
    \fancyfoot[CO,CE]{%
      \raisebox{\dimexpr\@FootJump\nbs-\nbs}{\@lspagenum\pagenumberstyle}
    }
  }
  % Not a user command, use plain or fancyplain:
  \fancypagestyle{fancynumber}{ % if has header but not footer
    \renewcommand\headrulewidth{0pt}
    \renewcommand\footrulewidth{0pt}
    \fancyhead[LO,RE,LE,RO,CE,CO]{}
    \fancyhead[LE]{%
      \makebox[2.5em][l]{\@lspagenum\pagenumberstyle}%
      \@myVersoEmblem%
    }
    \fancyhead[RO]{%
      \@myRectoEmblem%
      \makebox[2.5em][r]{\@lspagenum\pagenumberstyle}%
    }
    \fancyfoot[LO,RE,LE,RO,CE,CO]{}
  }
  % Now put `fancyhdr' to work:
  \pagestyle{fancy} % default unless over-ridden by \thispagestyle{}
  %
} % end \@ActivateHeadFootStyles
%
%%


%% Neutralize settings that cannot be used after Preamble:
\gdef\@DisableHeadFootSettings{% called by `novel.cls' \AtBeginDocument
  \LetLtxMacro\SetHeadFootStyle\relax
  \LetLtxMacro\SetHeadStyle\relax
  \LetLtxMacro\SetHeadJump\relax
  \LetLtxMacro\SetFootJump\relax
  \LetLtxMacro\SetLooseHead\relax
}% end \@DisableHeadFootSettings
%%

% The following settings can continue to be re-issued after \begin{document}:
% \SetEmblems  also \SetEmblem
% \SetPageNumberStyle
% \SetVersoHeadText  also \New and \Renew
% \SetRectoHeadText  also \New and \Renew


%
%% End of file `novel-HeadFootStyles.sty'


