%%
%% This is file `novel-DropCap.sty', part of `novel' package,
%% Copyright (C) 2017 Robert Allgeyer.
%%
%% It is based on `lettrine.sty', part of `lettrine' package,
%% Copyright (C) 1999-2015 Daniel Flipo.
%%
%% The license for this file is that same for `lettrine':
%
% This program can be distributed and/or modified under the terms
% of the LaTeX Project Public License either version 1.3c of this
% license or (at your option) any later version.
% The latest version of this license is in
%    http://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
%%
% This file is new (and included) in class `novel' version 1.48.
% In many cases, it may be used in other document classes as well.
% No guarantee for other classes! To try in other classes:
%   If you need color, first \RequirePackage[options]{xcolor}.
%   Install package `novel' in TeX,
%   but do not \usepackage{novel} or \RequirePackage{novel}.
%   Instead, \RequirePackage{novel-DropCap}.
%
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesFile{novel-DropCap.sty}
  [2017/12/06 v1.46.3b (Drop Caps)]
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\RequirePackage{keyval}
\RequirePackage{xparse}
\RequirePackage{xifthen}
\RequirePackage{xstring}
% Will require package `xcolor' if you use any color features.
% Not requested here, to avoid potential package option conflict.
%
\gdef\dropcapfont{} % until actually set, will be default main font
\newif \if@dropcapcolorset
\gdef\dropcapcolormodel{} % until actually set, using `xcolor' syntax
\gdef\dropcapcolorvalue{black} % until actually set, using `xcolor' syntax
\newif \if@dropcapfontset
\newcommand*\NDCcharstyle{}
%
\ExplSyntaxOn
% The argument to \SetDropCapFont is a font command.
% Example syntax, in traditional pdfLaTeX:
%   \SetDropCapFont{\fontfamily{ppl}\fontseries{bx}\fontshape{sl}}
% Example syntax, using `fontspec' in LuaLaTeX (maybe XeTeX, but not sure):
%   Create font command, such as: \newfontface\mynicefont[options]{fontname}
%   Then: \SetDropCapFont{\mynicefont}
\DeclareDocumentCommand \SetDropCapFont { m } {%
  \global\@dropcapfontsettrue%
  \gdef\@dropcapfont{#1}
  \renewcommand\NDCcharstyle{%
    #1%
    \if@dropcapcolorset%
      \ifthenelse{\equal{\dropcapcolormodel}{}}{%
        \color{\dropcapcolorvalue}%
      }{%
        \color[\dropcapcolormodel]{\dropcapcolorvalue}%
      }%
    \fi%
  }%
}%
% The argument(s) to \SetDropCapColor use `xcolor' syntax:
%   [colormodel]{value} OR {colorname}
\DeclareDocumentCommand \SetDropCapColor { O{} m } {%
  \@ifclassloaded{novel}{% includes `xcolor' monochrome or grayscale
    \if@graytext%
      \@setdropcapcolor[#1]{#2}%
    \else%
      \PackageWarning{novel}{Color of dropcap ignored unless class option `graytext'.}%
    \fi%
  }{%
    \@ifpackageloaded{xcolor}{%
      \@setdropcapcolor[#1]{#2}%
    }{%
      \PackageWarning{novel-DropCap}{Your \string\dropcap color setting was ignored.^^J%
       First load package `xcolor'.}%
    }%
  }%
}% end \SetDropCapColor
\DeclareDocumentCommand \@setdropcapcolor { O{} m } {%
  \global\@dropcapcolorsettrue%
  \gdef\dropcapcolormodel{#1}%
  \gdef\dropcapcolorvalue{#2}%
  \renewcommand\NDCcharstyle{%
    \@dropcapfont%
    \ifthenelse{\equal{\dropcapcolormodel}{}}{%
      \color{\dropcapcolorvalue}%
    }{%
      \color[\dropcapcolormodel]{\dropcapcolorvalue}%
    }%
  }%
}% end \@setdropcapcolor
% for convenience:
\cs_new_eq:NN \SetDropcapFont \SetDropCapFont
\cs_new_eq:NN \SetDropcapColor \SetDropCapColor
\ExplSyntaxOff
%
\newcounter{NDCDefaultLines}
\setcounter{NDCDefaultLines}{3}
\newcounter{NDCDefaultDepth}
\newdimen\NDCDefaultVoffset
\newdimen\NDCDefaultHoffset
\newcommand*{\NDCDefaultHscale}{1}
\newcommand*{\NDCDefaultVscale}{1}
\newdimen\NDCDefaultGap
\setlength{\NDCDefaultGap}{0.25em} % approx. width of normal space
\newsavebox{\NDC@dropcapbox}
\newsavebox{\NDC@normalXbox}
\newcounter{NDC@lines}
\newcounter{NDC@depth}
\newdimen\NDC@Pindent
\newdimen\NDC@Gap % equivalent to lettrine findent
\newdimen\NDC@Nindent % not a user setting
\newdimen\NDC@voffset
\newdimen\NDC@hoffset
\newdimen\NDC@first
\newdimen\NDC@next
\newdimen\NDC@height
\newcommand*{\NDC@ante}{}
\newcommand*{\NDC@hscale}{}
\newcommand*{\NDC@vscale}{}
\def\@getNDCheight{% hscale and offsets do not affect height:
   \@tempdima=\baselineskip
   \setlength{\NDC@height}{\value{NDC@lines}\@tempdima}%
   \addtolength{\NDC@height}{-\@tempdima}%
   \sbox{\NDC@normalXbox}{X}% Normal capital X, rather than something else.
   \addtolength{\NDC@height}{\ht\NDC@normalXbox}%
   \setlength{\NDC@height}{\NDC@vscale\NDC@height}%
}
\newcommand*{\NDCchar}{%
   \@getNDCheight%
   % Measures drop cap capital X, rather than something else:
   \sbox{\@tempboxa}{\NDCcharstyle\fontsize{\NDC@height}{\NDC@height}\selectfont X}%
   \@tempcntb=\ht\@tempboxa%
   \@tempcnta=\NDC@height%
   \multiply\@tempcnta by 100%
   \divide\@tempcntb by 100%
   \divide\@tempcnta by \@tempcntb%
   \advance\@tempcnta by -9999%
   \ifnum\@tempcnta>0%
     \def\@tempa{1.\the\@tempcnta}%
   \else%
     \def\@tempa{1}%
   \fi%
   \NDCcharstyle\fontsize{\@tempa\NDC@height}{\@tempa\NDC@height}\selectfont
}
\define@key{NDC}{lines}{\setcounter{NDC@lines}{#1}}
\define@key{NDC}{depth}{\setcounter{NDC@depth}{#1}}
\define@key{NDC}{hoffset}{\setlength{\NDC@hoffset}{#1}}
\define@key{NDC}{voffset}{\setlength{\NDC@voffset}{#1}}
\define@key{NDC}{ante}{\renewcommand*{\NDC@ante}{#1}}
\define@key{NDC}{gap}{\setlength{\NDC@Gap}{#1}}
\define@key{NDC}{hscale}{\renewcommand*{\NDC@hscale}{#1}}
\define@key{NDC}{vscale}{\renewcommand*{\NDC@vscale}{#1}}
\newdimen\NDCboxwidth
\newdimen\NDCboxheight
\newdimen\NDCboxdepth
%
\ExplSyntaxOn
\DeclareDocumentCommand \boxcap { m }{%
  \begingroup%
  % The model letter has no upper diacritical.
  \def\@NDCmodel{}
  \IfSubStr{ÀÁÂÃÄÅĀĂ}{#1}{\def\@NDCmodel{A}}{}
  \IfSubStr{ĆĈĊČ}{#1}{\def\@NDCmodel{C}}{}
  \IfSubStr{Ď}{#1}{\def\@NDCmodel{D}}{}
  \IfSubStr{ÈÉÊËĒĔĖĚ}{#1}{\def\@NDCmodel{E}}{}
  \IfSubStr{ĜĞĠ}{#1}{\def\@NDCmodel{G}}{}
  \IfSubStr{Ĥ}{#1}{\def\@NDCmodel{H}}{}
  \IfSubStr{ÌÍÎÏĨĪĬİ}{#1}{\def\@NDCmodel{I}}{}
  \IfSubStr{Ĵ}{#1}{\def\@NDCmodel{J}}{}
  \IfSubStr{Ĺ}{#1}{\def\@NDCmodel{L}}{}
  \IfSubStr{ÑŃŇ}{#1}{\def\@NDCmodel{N}}{}
  \IfSubStr{ÒÓÔÕÖŌŎŐ}{#1}{\def\@NDCmodel{O}}{}
  \IfSubStr{ŔŘ}{#1}{\def\@NDCmodel{R}}{}
  \IfSubStr{ŚŜŠ}{#1}{\def\@NDCmodel{S}}{}
  \IfSubStr{Ť}{#1}{\def\@NDCmodel{T}}{}
  \IfSubStr{ÙÚÛÜŨŪŬŮŰ}{#1}{\def\@NDCmodel{U}}{}
  \IfSubStr{Ŵ}{#1}{\def\@NDCmodel{W}}{}
  \IfSubStr{ÝŶŸ}{#1}{\def\@NDCmodel{Y}}{}
  \IfSubStr{ŹŻŽ}{#1}{\def\@NDCmodel{Z}}{}
  \IfSubStr{DŽ}{#1}{\def\@NDCmodel{DZ}}{} % diglyph
  %
  \setlength\fboxsep{0.16\nfs}%
  \setlength\fboxrule{0.02\nfs}%
  \ifthenelse{\equal{\@NDCmodel}{}}{%
    \framebox{\phantom{|}#1\phantom{|}}%
  }{%
    \framebox{\phantom{|\@NDCmodel}\llap{\smash{#1}}\phantom{|}}%
  }%
  \endgroup%
}% end boxcap
%
\DeclareDocumentCommand \dropcap { O{} m } {%
  \setcounter{NDC@lines}{\value{NDCDefaultLines}}%
  \setcounter{NDC@depth}{\value{NDCDefaultDepth}}%
  \setlength{\NDC@hoffset}{\NDCDefaultHoffset}%
  \renewcommand*{\NDC@hscale}{\NDCDefaultHscale}%
  \renewcommand*{\NDC@vscale}{\NDCDefaultVscale}%
  \setlength{\NDC@voffset}{\NDCDefaultVoffset}%
  \renewcommand*{\NDC@ante}{}%
  \setlength{\NDC@Gap}{\NDCDefaultGap}%
  \setlength{\NDC@Nindent}{0pt}%
  \setkeys{NDC}{#1}%
  \ifnum\value{NDC@lines}=1%
    \par\noindent%
    \NDC@ante%
    #2%
  \else%
    \sbox{\NDC@normalXbox}{X}% Normal capital X.
    \sbox{\NDC@dropcapbox}{\scalebox{\NDC@hscale}[1]{\NDCchar #2}}%
    \@tempdima=\baselineskip%
    \setlength{\NDC@first}{-\value{NDC@lines}\@tempdima}%
    \addtolength{\NDC@first}{\@tempdima}%
    \sbox{\@tempboxa}{X}%
    \addtolength{\NDC@first}{-\ht\@tempboxa}%
    \addtolength{\NDC@first}{\NDC@voffset}%
    \addtolength{\NDC@first}{\ht\NDC@dropcapbox}%
    \addtolength{\NDC@voffset}{-\value{NDC@lines}\@tempdima}%
    \addtolength{\NDC@voffset}{\@tempdima}%
    \par%
    \setlength{\NDC@Pindent}{\wd\NDC@dropcapbox}%
    \addtolength{\NDC@Pindent}{\NDC@hoffset}%
    \settowidth{\NDC@first}{\NDC@ante}%
    \addtolength{\NDC@Pindent}{\NDC@first}%
    \addtolength{\NDC@Pindent}{\NDC@Gap}%
    \setlength{\NDC@first}{\linewidth}%
    \addtolength{\NDC@first}{-\NDC@Pindent}%
    \addtolength{\NDC@Nindent}{\NDC@Pindent}%
    \setlength{\NDC@next}{\linewidth}%
    \addtolength{\NDC@next}{-\NDC@Nindent}%
    \addtolength{\NDC@Pindent}{\rightmargin}%
    \addtolength{\NDC@Nindent}{\rightmargin}%
    \setlength{\NDCboxwidth}{\wd\NDC@dropcapbox}%
    \setlength{\NDCboxheight}{\ht\NDC@dropcapbox}%
    \setlength{\NDCboxdepth}{\dp\NDC@dropcapbox}%
    \addtocounter{NDC@lines}{1}%
    \addtocounter{NDC@lines}{\value{NDC@depth}}%
    \def\NDC@parshape{\c@NDC@lines \the\NDC@Pindent \the\NDC@first}%
    \@tempcnta=\tw@%
    \@whilenum \@tempcnta<\c@NDC@lines\do{%
       \edef\NDC@parshape{\NDC@parshape \the\NDC@Nindent \the\NDC@next}%
       \advance\@tempcnta\@ne}%
    \edef\NDC@parshape{\NDC@parshape \rightmargin \the\linewidth}%
    \noindent%
    \parshape=\NDC@parshape\relax%
    \smash{%
      \llap{%
        \mbox{\NDC@ante}%
        \raisebox{\NDC@voffset}{\usebox{\NDC@dropcapbox}}%
        \hskip\the\NDC@Gap%
      }%
    }%
  \fi%
}% end @NDCdropcap
\ExplSyntaxOff
%
%%
%% End of file `novel-DropCap.sty'.

