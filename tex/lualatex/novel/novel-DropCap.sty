%%
%% This is file `novel-DropCap.sty', part of the `novel' package.
%% Copyright (c) 2017 Robert Allgeyer.
%% It is derived from file `lettrine.sty'
%% which is part of the `lettrine' package.
%% The original copyright and license, shown below, also applies:
%%
% Copyright (C) 1999-2015 Daniel Flipo.
%
% This program can be distributed and/or modified under the terms
% of the LaTeX Project Public License either version 1.3c of this
% license or (at your option) any later version.
% The latest version of this license is in
%    http://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%%

%%
% Some keys are the same as with lettrine:
%   lines, depth, slope, ante.
% Some keys do the same thing, with a slightly different name:
%   hang (lhang), oversize (loversize), raise (lraise).
% The image, realheight, grid, and novskip keys are not used.
%   In `novel' document class: Place image using `novel' \InlineImage syntax.
%   Otherwise: Use commands from `graphicx`.
%   The lines are always on grid. Any vskip is ignored.
% Lettrine's findent and nindent keys have substitutes:
%   gap is the separation between drop cap and text at right (=findent+nindent)
%   kern moves the first line (= -nindent)
%%
% The font used for the drop cap may be defined using `fontspec' syntax:
%   \NewFontFace\dropcapfont[Open Type features]{font name}
% You can use any scalable font. If you don't define \dropcapfont,
%   then the surrounding main font will be used.
% If your drop cap is within the Basic Latin, Latin-1 Supplement, or Latin Extended-A
%   character sets (plus a few punctuation characters) then try NovelDeco.otf.
%   This font has features `dcap' and `hlig' specifically designed for drop caps:
%     \NewFontFace\dropcapfont[RawFeature=+dcap,RawFeature=+hlig]{NovelDeco.otf}
%   Note that non-European, Greek, and Cyrillic are not in this font.
%   In this font, the drop cap letters have reduced descenders, so that
%   it is normally not necessary to use the depth key. Also, W is not very wide.
%%
% \dropcap[keys]{letter} does not take a second mandatory argument (unlike \lettrine).
% If you want small caps letters to follow, do it yourself with \textsc{text}.
% Advantage: You can manually choose enough letters to fill the first line with small caps.
% In lettrine, that doesn't work properly, because the text argument is in a box.
%%
% Although this file ships with `novel' document class (based on LuaLaTeX)
%   it probably works with other classes and compilers. Give it a try!
%   In Preamble: \RequirePackage{novel-DropCap}
%   In document body: \dropap[keys]{letter} text.
%%
% Unlike lettrine, this file does not read configuration files.
%%

\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesFile{novel-DropCap.sty}
             [2017/11/07 v1.44 LaTeX file (drop caps)]
\RequirePackage{keyval}
\newcounter{NDCdefaultLines}
\setcounter{NDCdefaultLines}{2}
\newcounter{NDCdefaultDepth}
\newcommand*{\NDCdefaultOversize}{0}
\newcommand*{\NDCdefaultRaise}{0}
\newcommand*{\NDCdefaultHang}{0}
\newdimen\NDCdefaultGap
\setlength{\NDCdefaultGap}{0.25em}
\newdimen\NDCdefaultSlope
\setlength{\NDCdefaultSlope}{\z@}
\newsavebox{\NDC@lbox}
\newsavebox{\NDC@tbox}
\newcounter{NDC@lines}
\newcounter{NDC@depth}
\newdimen\NDC@Pindent
\newdimen\NDC@Gap
\newdimen\NDC@Kern
\newdimen\NDC@Nindent
\newdimen\NDC@lraise
\newdimen\NDC@first
\newdimen\NDC@next
\newdimen\NDC@slope
\newdimen\NDC@height
\newcommand*{\NDC@file}{}
\newcommand*{\NDC@hang}{}
\newcommand*{\NDC@oversize}{}
\newcommand*{\NDC@raise}{}
\newcommand*{\NDC@ante}{}
%
\def\Dropcap@height{%
   \@tempdima=\baselineskip
   \setlength{\NDC@height}{\value{NDC@lines}\@tempdima}%
   \ifnum\value{NDC@lines}>1
     \addtolength{\NDC@height}{-\@tempdima}%
   \fi
   \ifvoid\NDC@tbox
     \sbox{\NDC@tbox}{\textsc{x}}%
   \fi
   \addtolength{\NDC@height}{\ht\NDC@tbox}%
   \addtolength{\NDC@height}{\NDC@oversize\NDC@height}%
}
%
\newcommand*{\StyleDropcap}{%
   \Dropcap@height
   \ifcsname dropcapfont \endcsname%
   \else%
     \let\dropcapfont\relax%
   \fi%
   \sbox{\@tempboxa}{{\dropcapfont\fontsize{\NDC@height}{\NDC@height}%
                     \selectfont X}}%
   \@tempcntb=\ht\@tempboxa
   \@tempcnta=\NDC@height
   \multiply\@tempcnta by 100
   \divide\@tempcntb by 100
   \divide\@tempcnta by \@tempcntb
   \advance\@tempcnta by -9999
   \ifnum\@tempcnta>0
     \def\@tempa{1.\the\@tempcnta}%
   \else
     \def\@tempa{1}%
   \fi
   \dropcapfont
   \fontsize{\@tempa\NDC@height}{\@tempa\NDC@height}%
   \selectfont
}
%
\define@key{NDC}{lines}{\setcounter{NDC@lines}{#1}}
\define@key{NDC}{depth}{\setcounter{NDC@depth}{#1}}
\define@key{NDC}{hang}{\renewcommand*{\NDC@hang}{#1}}
\define@key{NDC}{oversize}{\renewcommand*{\NDC@oversize}{#1}}
\define@key{NDC}{raise}{\renewcommand*{\NDC@raise}{#1}}
\define@key{NDC}{ante}{\renewcommand*{\NDC@ante}{#1}}
\define@key{NDC}{gap}{\setlength{\NDC@Gap}{#1}}
\define@key{NDC}{kern}{\setlength{\NDC@Kern}{#1}}
\define@key{NDC}{slope}{\setlength{\NDC@slope}{#1}}
\newdimen\DropcapWidth
\newdimen\DropcapHeight
\newdimen\DropcapDepth
%
\DeclareDocumentCommand\dropcap { O{} m } {%
  \setcounter{NDC@lines}{\value{NDCdefaultLines}}%
  \setcounter{NDC@depth}{\value{NDCdefaultDepth}}%
  \renewcommand*{\NDC@hang}{\NDCdefaultHang}%
  \renewcommand*{\NDC@oversize}{\NDCdefaultOversize}%
  \renewcommand*{\NDC@raise}{\NDCdefaultRaise}%
  \renewcommand*{\NDC@ante}{}%
  \setlength{\NDC@Gap}{\NDCdefaultGap}%
  \setlength{\NDC@Kern}{\z@}%
  \setlength{\NDC@Nindent}{\z@}%
  \setlength{\NDC@slope}{\NDCdefaultSlope}%
  \setkeys{NDC}{#1}%
  \sbox{\NDC@lbox}{{\StyleDropcap #2}}%
  \@tempdima=\baselineskip
  \ifnum\value{NDC@lines}=1
    \setlength{\NDC@first}{\ht\NDC@lbox}%
    \addtolength{\NDC@first}{-\ht\NDC@tbox}%
    \setlength{\NDC@lraise}{\z@}%
  \else
    \setlength{\NDC@first}{-\value{NDC@lines}\@tempdima}%
    \addtolength{\NDC@first}{\@tempdima}%
    \sbox{\@tempboxa}{\textsc{x}}%
    \addtolength{\NDC@first}{-\ht\@tempboxa}%
    \setlength{\NDC@lraise}{-\NDC@raise\NDC@first}%
    \addtolength{\NDC@first}{\NDC@lraise}%
    \addtolength{\NDC@first}{\ht\NDC@lbox}%
    \addtolength{\NDC@lraise}{-\value{NDC@lines}\@tempdima}%
    \addtolength{\NDC@lraise}{\@tempdima}%
  \fi
  \par
  \setlength{\NDC@Pindent}{\wd\NDC@lbox}%
  \addtolength{\NDC@Pindent}{-\NDC@hang\wd\NDC@lbox}%
  \settowidth{\NDC@first}{\NDC@ante}%
  \addtolength{\NDC@Pindent}{\NDC@first}%
  \addtolength{\NDC@Pindent}{\NDC@Gap}%
  \setlength{\NDC@first}{\linewidth}%
  \addtolength{\NDC@first}{-\NDC@Pindent}%
  \addtolength{\NDC@Nindent}{\NDC@Pindent}%
  \setlength{\NDC@next}{\linewidth}%
  \addtolength{\NDC@next}{-\NDC@Nindent}%
  \addtolength{\NDC@Pindent}{\rightmargin}%
  \addtolength{\NDC@Nindent}{\rightmargin}%
  \setlength{\DropcapWidth}{\wd\NDC@lbox}%
  \setlength{\DropcapHeight}{\ht\NDC@lbox}%
  \setlength{\DropcapDepth}{\dp\NDC@lbox}%
  \addtocounter{NDC@lines}{1}%
  \addtocounter{NDC@lines}{\value{NDC@depth}}%
  \def\NDC@parshape{\c@NDC@lines \the\NDC@Pindent \the\NDC@first}%
  \@tempcnta=\tw@
  \@whilenum \@tempcnta<\c@NDC@lines\do{%
     \edef\NDC@parshape{\NDC@parshape \the\NDC@Nindent \the\NDC@next}%
     \addtolength{\NDC@Nindent}{\NDC@slope}%
     \addtolength{\NDC@next}{-\NDC@slope}%
     \advance\@tempcnta\@ne}%
  \edef\NDC@parshape{\NDC@parshape \rightmargin \the\linewidth}%
  \noindent
  \parshape=\NDC@parshape\relax
  \smash{\llap{\mbox{\NDC@ante}\raisebox{\NDC@lraise}{\usebox{\NDC@lbox}}%
         \hskip \the\NDC@Gap}}\hskip \the\NDC@Kern %
} % end \dropcap
%%


%%
%% End of file `novel-DropCap.sty'.


