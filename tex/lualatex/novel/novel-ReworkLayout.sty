%%
%% This is file `novel-ReworkLayout.sty', a custom file.
%% Copyright 2017 Robert Allgeyer.
%% 
%% It may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
%%
\ProvidesFile{novel-ReworkLayout.sty}%
[2017/12/25 v1.46.5k LaTeX file (reworked layout calculations)]
%%

%%
%% File `novel-CalculateLayout.sty' calculated layout based on
%%   values from \Set commands, and defaults.
%% If no \Rework setting was used, the layout is final,
%%   so this file is not loaded.
%% But if the Preamble used one of both \Rework settings,
%%   then this file is loaded, and it re-processes the layout.
%% Normal font size and/or baselineskip are adjusted so that
%%   the paragraph structures and pagination that would have been
%%   produced by the first calculation, are retained after rework.
%% This is done in a single pass, without requiring re-compile.
%% It relies on the fact that when fonts and microtype settings are fixed,
%%   line breaks are determined by the artion of textwidth to font size.
%% And, when the lines per page is constant, page breaks are unchanged.
%% If this file is loaded, it is \AtEndPreamble, following
%%   `novel-CalculateLayout.sty', and preceding `novel-PostLayout.sty'.
%% Prior to v. 1.48, rework was within `novel-CalculateLayout.sty'.
%%


% These values come from \Rework commands, if used. But if not used,
%   the values are acquired from novel-CalculateLayout.sty:
\if@TrimSizeRework
  \gsetlength\@TrimWidth{\@ReworkTrimWidth}
  \gsetlength\@TrimHeight{\@ReworkTrimHeight}
\else
  \gsetlength\@TrimWidth{\@SetTrimWidth}
  \gsetlength\@TrimHeight{\@SetTrimHeight}
\fi
%
\if@MarginsRework
  \gsetlength\@TopMargin{\@ReworkTopMargin}
  \gsetlength\@OuterMargin{\@ReworkOuterMargin}
  \gsetlength\@BottomMargin{\@ReworkBottomMargin}
  \gsetlength\@InnerMargin{\@ReworkInnerMargin}
\else
  \gsetlength\@TopMargin{\@SetTopMargin}
  \gsetlength\@OuterMargin{\@SetOuterMargin}
  \gsetlength\@BottomMargin{\@SetBottomMargin}
  \gsetlength\@InnerMargin{\@SetInnerMargin}
\fi


% These values were calculated in novel-CalculateLayout.sty:
\newlength\@InitialWorkingHeight
  \gsetlength\@InitialWorkingHeight{\@WorkingHeight}
\newlength\@InitialTextWidth
  \gsetlength\@InitialTextWidth{\textwidth}


% Change \textwidth to the rework values:
\gsetlength\textwidth{\@TrimWidth-\@OuterMargin-\@InnerMargin}
\FPdiv{\@TWratio}{\strip@pt\textwidth}{\strip@pt\@InitialTextWidth}
\FPdiv{\@THratio}{\strip@pt\@WorkingHeight}{\strip@pt\@InitialWorkingHeight}


\if@AspectPriority
  % Simply scale both font size and baselineskip to the minimum ratio:
  \FPmin{\@TMratio}{\@TWratio}{\@THratio}
  \gsetlength\@FontSize{\@TMratio\@SetFontSize}
  \gsetlength\@WorkingHeight{\@TrimHeight-\@TopMargin-\@BottomMargin-1.3\@FontSize}
  \gsetlength\baselineskip{\@TMratio\baselineskip}
  \FPmul{\@tempN}{\@AdjLPP}{\strip@pt\baselineskip}
  \FPsub{\@VdiffN}{\strip@pt\@WorkingHeight}{\@tempN}
  \FPdiv{\@VdiffN}{\@VdiffN}{2}
  \gsetlength\@TopMargin{\@TopMargin+\@VdiffN pt}
  \gsetlength\@BottomMargin{\@BottomMargin+\@VdiffN pt}
\else
  % \baselineskip will be the largest that will fit.
  % Try with font size adjusted using \@TWratio:
  \gsetlength\@FontSize{\@TWratio\@SetFontSize}
  \gsetlength\@WorkingHeight{\@TrimHeight-\@TopMargin-\@BottomMargin-1.3\@FontSize}
  \FPdiv{\@tempN}{1}{\@AdjLPP}
  \gsetlength\baselineskip{\@tempN\@WorkingHeight}
  \ifdimcomp{\baselineskip}{<}{1.2\@FontSize}{
    % Does not fit vertically when \@FontSize adjusted to fit width.
    % Change \@FontSize to (1/1.2)\baselineskip, and scale \textwidth:
    \gsetlength\@FontSize{0.8333\baselineskip}
    \FPmul{\@tempN}{\@TWratio}{\strip@pt\@SetFontSize}
    \FPdiv{\@tempN}{1}{\@tempN}
    \FPmul{\@tempN}{\@tempN}{\strip@pt\@FontSize}
    \gsetlength\textwidth{\@tempN\textwidth}
    \FPsub{\@tempN}{1}{\@tempN}
    \FPdiv{\@tempN}{\@tempN}{2}
    \gsetlength\@OuterMargin{\@OuterMargin+\@tempN\textwidth}
    \gsetlength\@InnerMargin{\@InnerMargin+\@tempN\textwidth}
  }{} % OK, fits horizontally and vertically.
\fi




%% End of file `novel-ReworkLayout.sty'.


