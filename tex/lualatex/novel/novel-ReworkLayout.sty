%%
%% This is file `novel-ReworkLayout.sty', a custom file.
%% Copyright 2017 Robert Allgeyer.
%% 
%% It may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
%%
\ProvidesFile{novel-ReworkLayout.sty}%
[2018/01/02 v1.46.5q LaTeX file (reworked layout calculations)]
%%

%%
%% File `novel-CalculateLayout.sty' calculated layout based on
%%   values from \Set commands, and defaults.
%% If no \Rework setting was used, the layout is final,
%%   so this file is not loaded.
%% But if the Preamble used one of both \Rework settings,
%%   then this file is loaded, and it re-processes the layout.
%% Normal font size and/or baselineskip are adjusted so that
%%   the paragraph structures and pagination that would have been
%%   produced by the first calculation, are retained after rework.
%% This is done in a single pass, without requiring re-compile.
%% It relies on the fact that when fonts and microtype settings are fixed,
%%   line breaks are determined by the ratio of \textwidth to \NormalEmSize.
%% And, when \@LinesPerPage is constant, page breaks are unchanged,
%%   even if you decide to add or remove header/footer.
%% If this file is loaded, it is \AtEndPreamble, following
%%   `novel-CalculateLayout.sty', and preceding `novel-PostLayout.sty'.
%% Prior to v. 1.48, rework was within `novel-CalculateLayout.sty'.
%%


%% A few values from the original calculation must be stored:
\newlength\@OriginalEmSize
  \gsetlength\@OriginalEmSize{\@NormalEmSize}
\newlength\@OriginalTextWidth % same as original available width
  \gsetlength\@OriginalTextWidth{\textwidth}
\newlength\@OriginalHeight % includes header/footer
  \gsetlength\@OriginalHeight{\@AvailableHeight}
\newlength\@OriginalBaselineSkip
  \gsetlength\@OriginalBaselineSkip{\baselineskip}
%%


% Change the values of trim size and margins, as requested.
% If not changed, same as before:
\if@ReworkTrimSize
  \gsetlength\@TrimWidth{\@NewTrimWidth}
  \gsetlength\@TrimHeight{\@NewTrimHeight}
\fi
%
\if@ReworkMargins
  \gsetlength\@TopMargin{\@NewTopMargin}
  \gsetlength\@OuterMargin{\@NewOuterMargin}
  \gsetlength\@BottomMargin{\@NewBottomMargin}
  \gsetlength\@InnerMargin{\@NewInnerMargin}
\fi
% Re-calculate:
\gsetlength\@AvailableWidth{\@TrimWidth-\@OuterMargin-\@InnerMargin}
\gsetlength\@AvailableHeight{\@TrimHeight-\@TopMargin-\@BottomMargin}
%%

%%
\if@AspectPriority
  \FPdiv{\@TWratio}{\strip@pt\@AvailableWidth}{\strip@pt\@OriginalTextWidth}
  \FPdiv{\@THratio}{\strip@pt\@AvailableHeight}{\strip@pt\@OriginalHeight}
  \FPmin{\@TMratio}{\@TWratio}{\@THratio}
  \gsetlength\textwidth{\@TMratio\@OriginalTextWidth}
  \gsetlength\@NormalEmSize{\@TMratio\@OriginalEmSize}
  \gsetlength\baselineskip{\@TMratio\@OriginalBaselineSkip}
  % Find whether limiting factor is width or height:
  \ifdimcomp{\@THratio-\@THratio}{<}{0pt}{%
    \setlength\@tempLength{0.5\@AvailableWidth-0.5\textwidth}
    \gsetlength{\@OuterMargin}{\@OuterMargin+\@tempLength}
    \gsetlength{\@InnerMargin}{\@InnerMargin+\@tempLength}
    \FPround{\@tempN}{\strip@pt\@tempLength}{2}
    \setlength\@tempLength{\@tempN pt}
    \FPround{\@tempN}{\@TMratio}{4}
    \typeout{^^JClass `novel' Info: Rework preserving aspect ratio. ^^J%
      Each side margin \the\@tempLength\space over requested rework value. ^^J%
      Scale \@tempN\space applied to text size and baselineskip. ^^J%
    }
  }{%
    \setlength\@tempLength{\@AvailableHeight-\@AdjLPP\baselineskip}
    \setlength\@tempLength{\@tempLength-\baselineskip+\@NormalEmSize}
    \setlength\@tempLength{0.5\@tempLength}
    \gsetlength{\@TopMargin}{\@TopMargin+\@tempLength}
    \gsetlength{\@BottomMargin}{\@BottomMargin+\@tempLength}
    \FPround{\@tempN}{\strip@pt\@tempLength}{2}
    \setlength\@tempLength{\@tempN pt}
    \FPround{\@tempN}{\@TMratio}{4}
    \typeout{^^JClass `novel' Info: Rework preserving aspect ratio. ^^J Each%
      vertical margin \the\@tempLength\space over requested rework value. ^^J%
      Scale \@tempN\space applied to text size and baselineskip. ^^J%
    }
  } % end \ifdimcomp
\else % margins priority:
  % Discover what happens if scaled according to text width:
  \gsetlength\textwidth{\@AvailableWidth}
  \FPdiv{\@TWratio}{\strip@pt\textwidth}{\strip@pt\@OriginalTextWidth}
  \gsetlength\@NormalEmSize{\@TWratio\@OriginalEmSize}
  \gsetlength\baselineskip{1.2\@NormalEmSize} % test for least allowable
  \setlength\@tempLength{\@AdjLPP\baselineskip}
  \ifdimcomp{\@AvailableHeight-\@tempLength}{<}{0pt}{%
    % Will not fit vertically, so will need to re-scale \@NormalEmSize.
    \gsetlength\@NormalEmSize{\@OriginalEmSize}
    \FPadd{\@AdjLPP}{\@AdjLPP}{1.3}
    \FPdiv{\@InvAdjLPP}{1}{\@AdjLPP}
    \gsetlength\baselineskip{\@InvAdjLPP\@AvailableHeight}
    \FPdiv\@THratio{\strip@pt\baselineskip}{\strip@pt\@OriginalBaselineSkip}
    \gsetlength\@NormalEmSize{0.8333\baselineskip} % 0.8333 = 1/1.2, tight skip
    \FPdiv{\@tempN}{\strip@pt\@NormalEmSize}{\strip@pt\@OriginalEmSize}
    \gsetlength\textwidth{\@tempN\@OriginalTextWidth}
    \gsetlength\@OuterMargin{%
      0.5\@OuterMargin+0.5\@TrimWidth-0.5\@InnerMargin-0.5\textwidth%
    }
    \gsetlength\@InnerMargin{%
      0.5\@InnerMargin+0.5\@TrimWidth-0.5\@OuterMargin-0.5\textwidth%
    }
    \FPround{\@ActualOuterN}{\strip@pt\@OuterMargin}{2}
    \FPround{\@ActualInnerN}{\strip@pt\@InnerMargin}{2}
    \FPmul{\@TWratio}{\@TWratio}{\@THratio}
    \FPmul{\@THratio}{\@TWratio}{1.2}
    \FPround{\@TWratio}{\@TWratio}{4}
    \FPround{\@THratio}{\@THratio}{4}
    \typeout{^^JClass `novel' Info: Reworked side margins enlarged. ^^J%
      Actual Outer Margin is now \@ActualOuterN pt. ^^J%
      Actual Inner Margin is now \@ActualInnerN pt. ^^J%
      Scale \@TWratio\space applied to text, ^^J%
      \@THratio\space applied to baselineskip. ^^J%
    }%
  }{% Fits vertically. Keep \@NormalEmSize. Calculate \baselineskip to fit:
      \gsetlength\@AvailableHeight{\@AvailableHeight-1.3\@NormalEmSize}
      \gsetlength\baselineskip{\@InvAdjLPP\@AvailableHeight}
      \FPdiv{\@BLratio}{\strip@pt\baselineskip}{\strip@pt\@OriginalBaselineSkip}
      \FPround{\@BLratio}{\@BLratio}{4}
      \FPround{\@TWratio}{\@TWratio}{4}
      \typeout{^^JClass `novel' Info: Rework was able to fit new margins. ^^J%
        Scale applied to font size: \@TWratio. ^^J%
        Scale applied to baselineskip: \@BLratio. ^^J%
      }%
  }% end \ifdimcomp.
\fi
%%


%% End of file `novel-ReworkLayout.sty'.


