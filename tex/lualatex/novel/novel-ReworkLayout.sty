%%
%% This is file `novel-ReworkLayout.sty', a custom file.
%% Copyright 2017 Robert Allgeyer.
%% 
%% It may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
%%
\ProvidesFile{novel-ReworkLayout.sty}%
[2017/12/27 v1.46.5n LaTeX file (reworked layout calculations)]
%%

%%
%% File `novel-CalculateLayout.sty' calculated layout based on
%%   values from \Set commands, and defaults.
%% If no \Rework setting was used, the layout is final,
%%   so this file is not loaded.
%% But if the Preamble used one of both \Rework settings,
%%   then this file is loaded, and it re-processes the layout.
%% Normal font size and/or baselineskip are adjusted so that
%%   the paragraph structures and pagination that would have been
%%   produced by the first calculation, are retained after rework.
%% This is done in a single pass, without requiring re-compile.
%% It relies on the fact that when fonts and microtype settings are fixed,
%%   line breaks are determined by the ratio of \textwidth to \NormalEmSize.
%% And, when \@LinesPerPage is constant, page breaks are unchanged,
%%   even if you decide to add or remove header/footer.
%% If this file is loaded, it is \AtEndPreamble, following
%%   `novel-CalculateLayout.sty', and preceding `novel-PostLayout.sty'.
%% Prior to v. 1.48, rework was within `novel-CalculateLayout.sty'.
%%


%% A few values from the original calculation must be stored:
\newlength\@OriginalEmSize
  \gsetlength\@OriginalEmSize{\@NormalEmSize}
\newlength\@OriginalTextWidth
  \gsetlength\@OriginalTextWidth{\textwidth}
\newlength\@OriginalBaselineSkip
  \gsetlength\@OriginalBaselineSkip{\baselineskip}
%%


% These values come from \Rework commands, if used. But if not used,
%   the values are acquired from novel-CalculateLayout.sty:
\if@ReworkTrimSize
  \gsetlength\@TrimWidth{\@NewTrimWidth}
  \gsetlength\@TrimHeight{\@NewTrimHeight}
\fi
%
\if@ReworkMargins
  \gsetlength\@TopMargin{\@NewTopMargin}
  \gsetlength\@OuterMargin{\@NewOuterMargin}
  \gsetlength\@BottomMargin{\@NewBottomMargin}
  \gsetlength\@InnerMargin{\@NewInnerMargin}
\fi
% Re-calculate:
\gsetlength\@AvailableWidth{\@TrimWidth-\@OuterMargin-\@InnerMargin}
\gsetlength\@AvailableHeight{\@TrimHeight-\@TopMargin-\@BottomMargin}
%%


% Discover what happens if scaled according to text width:
\gsetlength\textwidth{\@AvailableWidth}
\FPdiv{\@TWratio}{\strip@pt\textwidth}{\strip@pt\@OriginalTextWidth}
\gsetlength\@NormalEmSize{\@TWratio\@OriginalEmSize}
\gsetlength\baselineskip{1.2\@NormalEmSize} % test for least allowable
\FPadd{\@tempN}{\@HeadJump}{\@LinesPerPage}
\FPadd{\@tempN}{\@tempN}{\@FootJumpFix}
\setlength\@tempLength{\@tempN\baselineskip}
\ifdimcomp{\@AvailableHeight-\@tempLength}{<}{0pt}{%
  % Will not fit vertically, so will need to re-scale \@NormalEmSize.
  \FPdiv\@THratio{\strip@pt\@AvailableHeight}{\strip@pt\@tempLength}
  \gsetlength\baselineskip{\@THratio\baselineskip}
  \gsetlength\@NormalEmSize{\@THratio\@NormalEmSize}
  \gsetlength\textwidth{\@THratio\textwidth}
  \setlength\@tempLength{\@TrimWidth-\@OuterMargin-\@InnerMargin-\textwidth}
  \setlength\@tempLength{0.5\@tempLength}
  \gsetlength\@OuterMargin{\@OuterMargin+\@tempLength}
  \gsetlength\@InnerMargin{\@InnerMargin+\@tempLength}
  \FPround{\@tempN}{\strip@pt\@tempLength}{2}
  \FPmul{\@TWratio}{\@TWratio}{\@THratio}
  \FPmul{\@THratio}{\@TWratio}{1.2}
  \FPround{\@TWratio}{\@TWratio}{4}
  \FPround{\@THratio}{\@THratio}{4}
  \typeout{^^JClass `novel' Info: Rework could not fit new horizontal margins. ^^J%
    Outer/Inner margins increased \@tempN pt over rework specs. ^^J%
    Scale \@TWratio\space applied to text, \@THratio\space applied to baselineskip. ^^J%
  }%
}{% Fits vertically. Keep \@NormalEmSize. Calculate \baselineskip to fit vertically:
  \FPdiv{\@tempN}{1}{\@tempN}
  \gsetlength\baselineskip{\@tempN\@AvailableHeight}
  \FPdiv{\@tempN}{\strip@pt\baselineskip}{\strip@pt\@OriginalBaselineSkip}
  \FPround{\@tempN}{\@tempN}{4}
  \FPround{\@TWratio}{\@TWratio}{4}
  \typeout{^^JClass `novel' Info: Rework was able to fit new margins. ^^J%
    Scale applied to font size: \@TWratio. ^^J%
    Scale applied to baselineskip: \@tempN. ^^J%
  }%
}% end \ifdimcomp.



%% End of file `novel-ReworkLayout.sty'.


